{% from 'components/generic/elements.jinja2' import action_button, breadcrumbs %}


{#---------------------------------------------------------------------------#
    CONVERSATION LIST
 #---------------------------------------------------------------------------#}
{% macro conversation_list(conversations,
                           title=_('Conversas ativas agora'),
                           subtitle=_('Veja as conversas abaixo e dê sua opinião')) %}
    <div class="ConversationList">
        <div class="ConversationList-title">
            {% if caller %}{{ caller() }}{% endif %}
            <h1>{{ title }}</h1>
            <h2>{{ subtitle }}</h2>
        </div>

        {# Cards #}
        <div class="ConversationList-cardList">
            {% for conversation in conversations %}
                {{ conversation_card(conversation) }}
            {% endfor %}
        </div>
        {# {{ conversation_pagination() }} #}
    </div>
{% endmacro %}


{% macro conversation_card(conversation) %}
    <div class="ConversationCard">
        <div class="ConversationCard-cover">
            <h1>
                <a href="{{ conversation.get_absolute_url() }}" alt="alt">{{ conversation.title }}</a>
            </h1>
            <dl>
                <dt>Assunto</dt>
                <dd>{{ conversation.category_name }}</dd>
            </dl>
        </div>
        <div class="ConversationCard-actions">
            <ul class="ConversationCard-statistics">
                <li><strong>{{ conversation.comments.count() }}</strong> comentários</li>
                <li><strong>{{ conversation.votes.count() }}</strong> votos</li>
            </ul>
            {{ action_button('Participe agora!', conversation.get_absolute_url()) }}
        </div>
    </div>
{% endmacro %}

{% macro conversation_pagination() %}
    <div class="ConversationPagination">
        <div class="ConversationPagination-pager">
            <a href="prev">&lt;</a> ... <a href="prev">&gt;</a>
        </div>
    </div>
{% endmacro %}

{#---------------------------------------------------------------------------#
    CONVERSATION DETAIL
 #---------------------------------------------------------------------------#}

{% macro conversation_detail(conversation, user) %}
    <div class="ConversationDetail">
        <div class="ConversationDetail-banner">
            {{ conversation_breadcrumbs(conversation) }}
            <h1>{{ conversation.question }}</h1>
            <dl class="ConversationDetail-statistics">
                <dt>Votos</dt>
                <dd>{{ conversation.votes.count() }}</dd>
                <dt>Comentários</dt>
                <dd>{{ conversation.comments.count() }}</dd>
            </dl>
        </div>

        {# Current comment #}
        {% if comment %}
            {{ comment_detail(comment, user) }}
        {% else %}
            <p class="Comment">Conversa não contêm comentários</p>
        {% endif %}

        {# Post a new comment #}
        {% if user.is_authenticated %}
            {{ comment_form() }}
        {% endif %}

        {# Opinion #}
        {% if conversation.opinion %}
            {{ opinion(conversation) }}
        {% endif %}
    </div>
{% endmacro %}


{% macro comment_detail(comment, user) %}
    <div class="Comment">
        <div>{{ comment.author.name }}</div>
        <p>{{ comment.content }}</p>
        {% if user.is_authenticated %}
            <form method="post">
                {{ csrf_input }}
                <input type="hidden" name="action" value="vote">
                <ul class="ConversationComment-actions">
                    <li><input type="submit" value="Concordo" name="agree"></li>
                    <li><input type="submit" value="Passo" name="pass"></li>
                    <li><input type="submit" value="Discordo" name="disagree"></li>
                </ul>
            </form>
        {% else %}
            <p class="Comment-loginWarn">É necessário <a href="/login/?next={{ comment.conversation.get_absolute_url() }}">registrar-se</a> antes de
                votar ou enviar um comentário!</p>
        {% endif %}
    </div>
{% endmacro %}


{% macro comment_form() %}
    <div class="CommentForm">
        <h1>Envie um comentário</h1>
        <form method="post">
            {{ csrf_input }}
            <input type="hidden" name="action" value="comment">
            <textarea name="comment"></textarea>
            <input type="submit" name="submit" value="Enviar comentário">
        </form>
    </div>
{% endmacro %}

{% macro opinion(conversation) %}
    <article class="ConversationOpinion">
        <h1>...</h1>
        <h2>Nossa opinião</h2>
        <p>{{ conversation.opinion }}</p>
    </article>
{% endmacro %}


{#---------------------------------------------------------------------------#
    AUXILIARY
 #---------------------------------------------------------------------------#}

{% macro conversation_breadcrumbs(conversation, has_home=True) %}
    {% set links = [
        ('conversations', 'Conversas'),
        (conversation.category.slug, conversation.category.name),
        (conversation.slug, conversation.title),
    ] %}
    {{ breadcrumbs(links, has_home=has_home) }}
{% endmacro %}


{% macro category_breadcrumbs(category, has_home=True) %}
    {% set links = [
        ('conversations', 'Conversas'),
        (category.slug, category.name),
    ] %}
    {{ breadcrumbs(links, has_home=has_home) }}
{% endmacro %}


{#---------------------------------------------------------------------------#
    CONVERSATION INFO
 #---------------------------------------------------------------------------#}
{% macro conversation_info(conversation, info) %}
    <div class="ConversationInfo Container">
        <h1>Info: <em>{{ conversation.title }}</em></h1>
        <article>
            <dl>
                {% for name, value in info.items() %}
                    <dt>{{ name }}</dt>
                    {% if value.__class__ == dict %}
                        <dd>
                            <dl>
                                {% for k, v in value.items() %}
                                    <dt>{{ k }}</dt>
                                    <dd>{{ v }}</dd>
                                {% endfor %}
                            </dl>
                        </dd>
                    {% else %}
                        <dd>{{ value }}</dd>
                    {% endif %}
                {% endfor %}
            </dl>
        </article>

        <h1>Comments</h1>
        <table>
            <thead>
            <tr>
                <th>Comment</th>
                <th>Author</th>
                <th>Votes</th>
                <th>Agree</th>
                <th>Disagree</th>
                <th>Skip</th>
                <th>Unvoted</th>
            </tr>
            </thead>
            <tbody>
            {% for comment in conversation.comments.all() %}
                <tr>
                    {% set stats = comment.get_statistics(ratios=True) %}
                    <td>{{ comment.content }}</td>
                    <td>{{ comment.author.name }}</td>
                    <td>{{ stats.total }}</td>
                    <td>{{ stats.agree_ratio | pc }}</td>
                    <td>{{ stats.disagree_ratio | pc }}</td>
                    <td>{{ stats.skip_ratio | pc }}</td>
                    <td>{{ stats.missing_ratio | pc }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
{% endmacro %}
